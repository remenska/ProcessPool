[dirac@lbvobox02 log]$ ps -eLF | grep RequestExecuting
dirac     4830  8316  4830  2    4 147586 51008  0 11:10 ?        00:02:41 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4830  8316  4866  0    4 147586 51008  1 11:10 ?        00:00:03 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4830  8316  4985  0    4 147586 51008  1 11:10 ?        00:00:01 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4830  8316  4986  0    4 147586 51008  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4984  4830  4984  0    4 181358 61804  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4984  4830  4987  0    4 181358 61804  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4984  4830  6481  0    4 181358 61804  0 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4984  4830 25634  9    4 181358 61804  0 13:13 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4999  4830  4999  0    4 183407 58844  0 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4999  4830  5000  0    4 183407 58844  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4999  4830  6146  0    4 183407 58844  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     4999  4830 25710  5    4 183407 58844  0 13:13 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5022  4830  5022  0    3 183408 58248  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5022  4830  5023  0    3 183408 58248  0 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5022  4830  5564  0    3 183408 58248  1 11:11 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5039  4830  5039  0    4 183410 58144  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5039  4830  5040  0    4 183410 58144  0 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5039  4830  6200  0    4 183410 58144  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5039  4830 25460  9    4 183410 58144  1 13:13 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5055  4830  5055  0    4 183413 59080  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5055  4830  5056  0    4 183413 59080  0 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5055  4830  6767  0    4 183413 59080  0 11:13 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5055  4830 25658  9    4 183413 59080  1 13:13 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5067  4830  5067  0    3 180853 61304  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5067  4830  5069  0    3 180853 61304  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5067  4830  6405  0    3 180853 61304  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5072  4830  5072  0    4 180856 63164  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5072  4830  5073  0    4 180856 63164  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5072  4830  6350  0    4 180856 63164  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5072  4830 25681  7    4 180856 63164  1 13:13 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_RequestExecutingAgent.cfg
dirac     5113  4830  5113  0    3 183418 58384  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/
dirac     5113  4830  5114  0    3 183418 58384  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/
dirac     5113  4830  6075  0    3 183418 58384  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/

------------
dirac     8316  0.0  0.0   3940   352 ?        S    Mar17   0:00  \_ runsv RequestManagement_RequestExecutingAgent
dirac     4830  2.3  1.2 590344 51008 ?        SNl  11:10   2:58      \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Reques
dirac     4984  8.9  1.5 725428 61852 ?        SNl  11:10  11:11          \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Re
dirac    26792  0.2  1.5 747884 61684 ?        SN   13:15   0:00          |   \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagemen
dirac     4999  9.5  1.4 733628 58848 ?        SNl  11:10  12:00          \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Re
dirac     5022  9.6  1.4 733632 58280 ?        SNl  11:10  12:03          \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Re
dirac     5039 10.1  1.4 733644 58148 ?        SNl  11:10  12:43          \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Re
dirac     5055  9.6  1.4 733648 59096 ?        SNl  11:10  12:04          \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Re
dirac    27077  0.0  1.3 733648 54056 ?        RN   13:16   0:00          |   \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagemen
dirac     5067 10.1  1.5 723412 61340 ?        SNl  11:10  12:39          \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Re
dirac     5072  9.6  1.5 723424 63160 ?        SNl  11:10  12:09          \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Re
dirac     5113 10.1  1.4 733672 58420 ?        SNl  11:10  12:46          \_ python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Re

ps -eLF
LWP = lightweight process ID
------------
UID        PID  PPID   LWP  C NLWP    SZ   RSS PSR STIME TTY          TIME CMD
dirac     4830  8316  4830  2    4 147586 51008  0 11:10 ?        00:02:42 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4830  8316  4866  0    4 147586 51008  0 11:10 ?        00:00:03 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4830  8316  4985  0    4 147586 51008  0 11:10 ?        00:00:01 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4830  8316  4986  0    4 147586 51008  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4984  4830  4984  0    4 181358 61840  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4984  4830  4987  0    4 181358 61840  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4984  4830  6481  0    4 181358 61840  0 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4984  4830 25979 12    4 181358 61840  1 13:14 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4999  4830  4999  0    4 183407 58856  0 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4999  4830  5000  0    4 183407 58856  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4999  4830  6146  0    4 183407 58856  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     4999  4830 25710  8    4 183407 58856  0 13:13 ?        00:00:05 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5022  4830  5022  0    4 183408 58284  0 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5022  4830  5023  0    4 183408 58284  0 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5022  4830  5564  0    4 183408 58284  1 11:11 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5022  4830 25744  9    4 183408 58284  0 13:13 ?        00:00:05 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5039  4830  5039  0    4 183411 58136  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5039  4830  5040  0    4 183411 58136  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5039  4830  6200  0    4 183411 58136  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5039  4830 26160  7    4 183411 58136  1 13:14 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5055  4830  5055  0    4 183412 59076  0 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5055  4830  5056  0    4 183412 59076  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5055  4830  6767  0    4 183412 59076  0 11:13 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5055  4830 26011 10    4 183412 59076  0 13:14 ?        00:00:01 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5067  4830  5067  0    4 180853 61340  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5067  4830  5069  0    4 180853 61340  0 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5067  4830  6405  0    4 180853 61340  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5067  4830 25780 12    4 180853 61340  1 13:13 ?        00:00:06 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5072  4830  5072  0    4 180856 63172  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5072  4830  5073  0    4 180856 63172  1 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5072  4830  6350  0    4 180856 63172  1 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5072  4830 25681  9    4 180856 63172  1 13:13 ?        00:00:05 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5113  4830  5113  0    4 183419 58412  1 11:10 ?        00:00:02 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5113  4830  5114  0    4 183419 58412  0 11:10 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5113  4830  6075  0    4 183419 58412  0 11:12 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ
dirac     5113  4830 26175  7    4 183419 58412  1 13:14 ?        00:00:00 python /opt/dirac/pro/DIRAC/Core/scripts/dirac-agent.py RequestManagement/RequestExecutingAgent /opt/dirac/pro/etc/RequestManagement_Requ


-----------

http://stackoverflow.com/questions/5488257/how-to-troubleshoot-bypass-locking-problem-which-appears-to-be-gil-related
An obscure lock-up between two threads seems to be related to the Global Interpreter Lock or some other "behind-the-scenes-lock", and I am at a loss how to continue troubleshooting. Any tips how to eliminate the lock-up would be appreciated.

The issue reproduces (erratically and somewhat random) in a larger set of code. The code is strictly python. Python version is 2.6.5 (on Linux). Hours of troubleshooting has reduced the problem when the lock-up occurs to the following:

The program has only two running threads
The threads concurrently call a method protected by a single threading.RLock
Thread 1 has acquired the lock [plus some other locks] via acquire()
Thread 2 has called acquire() and is confirmed to be waiting for the lock
Thread 1 is able to do print to the console with print(), however it is getting locked up by a simple non-blocking library call
The offensive call in #5 is the function unicode.encode, which should be non-blocking. The following code in Thread 1 at the position where the thread locks will (as expected) print 'A' and 'B':

print('A')
print('B')
However, the following will just print 'A' and block the thread:

print('A')
u'hello'.encode('utf8') # This dummy (non-blocking) call locks up Thread 1
print('B')
This makes no sense to me at all. There is no logical dead-lock condition existing between the two threads. Thread 1 is being blocked by a non-blocking library call that is not in any way interfering with Thread 2, which is just silently waiting to acquire an RLock. The only cause I can think of for Thread 1 being blocked is that it is waiting for the GIL.

What I found was troubling: my stuck python process was sitting in a futex() syscall which would never return. A bit of reading taught me this was just its way of waiting for a lock to clear, but there was nothing which could clear it. It had just forked, it was just one thread, and nobody else was accessing that memory. It would be there forever.

So I added logging to start figuring out what else was going on during all of this. Perversely, it actually got worse. The highly-instrumented code would freeze its children far more than the untouched stuff. This was a clue, however frustrating it was.

I wound up learning how to use gdb on a Python process -- yep, you can actually get meaningful stack trace data -- and found out that my newly forked process was getting stuck deep in some Python library logging call. That call acquired a mutex, which in this case was implemented with futex(). It would get stuck because someone else already had it.

But wait, how could someone else have the mutex when we just came from a fork() moments ago? This was a mystery briefly, until I started doing traces on the parent process with gdb and friends. That's what finally cracked the puzzle.

Back in the parent process, there were many threads running around doing things. Even though the actual testing suite itself never used threads, it had called upon that SSH library which did quite prolifically. I already knew threading and fork was a no-no, but had to prove it to these people some other way, since they obviously didn't know this principle already and would never take me at face value.

I wound up gathering instrumentation which showed one of the SSH library threads calling the Python log call while another thread called fork(). That fork did the usual copy-on-write thing, and so the child woke up with all of the parent's data structures, including whatever bit that said "someone has this lock". But, since there was no one to finish using it and release it on the child side, the first call to logging there would block forever.

This should have made a solid case for dumping SSH and that library altogether, but it didn't quite work out like that. Last I heard, they were still working on a way to safely allow fork() in a threaded process by running around and cleaning up mutexes in some kind of "at fork" handler.

I wish I was making that up.


Scribblings:
-----------------------
multiprocessing.Queue:
http://docs.python.org/2/library/multiprocessing.html says "Queues are thread and process safe."
On the other hand, we use locks all over the place:

def queueTask(...
...
 self.__prListLock.acquire()
    try:
      self.__pendingQueue.put( task, block = blocking )
    except Queue.Full:
      self.__prListLock.release()
      return S_ERROR( "Queue is full" )
    finally:
      self.__prListLock.release()
-------------

